--========================
-- OverHub Autofarm UI + Bootstrap (Snippet 1/2)
--========================

-- Services
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local StarterGui = game:GetService("StarterGui")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")

local Player = Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")
local camera = workspace.CurrentCamera

-- Soft blur intro
local Blur = Instance.new("BlurEffect")
Blur.Enabled = true
Blur.Size = 0
Blur.Parent = camera

-- Remove duplicates
for _, n in ipairs({"DiamondFarmGUI","AutoFarmDiamondsGUI"}) do
    local f = PlayerGui:FindFirstChild(n)
    if f then f:Destroy() end
end

-- Gui
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "AutoFarmDiamondsGUI"
ScreenGui.ResetOnSpawn = false
ScreenGui.IgnoreGuiInset = true
ScreenGui.Parent = PlayerGui

local Root = Instance.new("Frame")
Root.Name = "Root"
Root.Size = UDim2.new(0, 430, 0, 232)
Root.Position = UDim2.new(0.5, 0, 0.48, 0)
Root.AnchorPoint = Vector2.new(0.5, 0.5)
Root.BackgroundColor3 = Color3.fromRGB(18, 38, 22)
Root.BackgroundTransparency = 1
Root.BorderSizePixel = 0
Root.ClipsDescendants = true
Root.Parent = ScreenGui

local RootCorner = Instance.new("UICorner")
RootCorner.CornerRadius = UDim.new(0, 14)
RootCorner.Parent = Root

local RootStroke = Instance.new("UIStroke")
RootStroke.Thickness = 1
RootStroke.Color = Color3.fromRGB(60, 200, 140)
RootStroke.Transparency = 0.1
RootStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
RootStroke.Parent = Root

local Glow = Instance.new("ImageLabel")
Glow.Name = "Glow"
Glow.BackgroundTransparency = 1
Glow.AnchorPoint = Vector2.new(0.5, 0.5)
Glow.Position = UDim2.fromScale(0.5, 0.5)
Glow.Size = UDim2.new(1, 120, 1, 120)
Glow.Image = "rbxasset://textures/whiteSquare.png"
Glow.ImageColor3 = Color3.fromRGB(60, 210, 150)
Glow.ImageTransparency = 0.86
Glow.ScaleType = Enum.ScaleType.Slice
Glow.SliceCenter = Rect.new(10,10,246,246)
Glow.Parent = Root

local Bg = Instance.new("Frame")
Bg.Name = "Background"
Bg.Size = UDim2.fromScale(1, 1)
Bg.BackgroundColor3 = Root.BackgroundColor3
Bg.BackgroundTransparency = 1
Bg.BorderSizePixel = 0
Bg.Parent = Root

local BgCorner = Instance.new("UICorner")
BgCorner.CornerRadius = UDim.new(0, 14)
BgCorner.Parent = Bg

local BgGradient = Instance.new("UIGradient")
BgGradient.Color = ColorSequence.new({
    ColorSequenceKeypoint.new(0.0, Color3.fromRGB(22, 56, 32)),
    ColorSequenceKeypoint.new(1.0, Color3.fromRGB(18, 96, 58))
})
BgGradient.Rotation = 90
BgGradient.Parent = Bg

local HeaderBar = Instance.new("Frame")
HeaderBar.Name = "HeaderBar"
HeaderBar.BackgroundTransparency = 1
HeaderBar.Size = UDim2.new(1, -20, 0, 40)
HeaderBar.Position = UDim2.new(0, 10, 0, 10)
HeaderBar.Parent = Root

local Left = Instance.new("Frame")
Left.BackgroundTransparency = 1
Left.Size = UDim2.new(0.5, -5, 1, 0)
Left.Parent = HeaderBar

local Right = Instance.new("Frame")
Right.BackgroundTransparency = 1
Right.Size = UDim2.new(0.5, -5, 1, 0)
Right.Position = UDim2.new(0.5, 10, 0, 0)
Right.Parent = HeaderBar

local Title = Instance.new("TextLabel")
Title.Name = "Title"
Title.BackgroundTransparency = 1
Title.AnchorPoint = Vector2.new(0, 1)
Title.Position = UDim2.new(0, 0, 1, 0)
Title.Size = UDim2.new(1, 0, 1, 0)
Title.Text = "OverHub Autofarm"
Title.Font = Enum.Font.GothamBold
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.TextScaled = true
Title.TextXAlignment = Enum.TextXAlignment.Left
Title.TextTransparency = 1
Title.Parent = Left

local CopyBtn = Instance.new("TextButton")
CopyBtn.Name = "CopyDiscord"
CopyBtn.AnchorPoint = Vector2.new(1, 1)
CopyBtn.Position = UDim2.new(1, 0, 1, 0)
CopyBtn.Size = UDim2.new(0, 190, 1, 4)
CopyBtn.BackgroundTransparency = 1
CopyBtn.Text = "Copy Discord Link"
CopyBtn.Font = Enum.Font.GothamBold
CopyBtn.TextScaled = true
CopyBtn.TextColor3 = Color3.fromRGB(60, 200, 140)
CopyBtn.Parent = Right

local CopyCorner = Instance.new("UICorner")
CopyCorner.CornerRadius = UDim.new(0, 10)
CopyCorner.Parent = CopyBtn

local CopyStroke = Instance.new("UIStroke")
CopyStroke.Thickness = 1
CopyStroke.Color = Color3.fromRGB(60, 200, 140)
CopyStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
CopyStroke.Parent = CopyBtn

local Status = Instance.new("TextLabel")
Status.Name = "Status"
Status.BackgroundTransparency = 1
Status.Size = UDim2.new(1, -34, 0, 86)
Status.Position = UDim2.new(0, 17, 0.47, -43)
Status.Text = "AUTOFARM: ON"
Status.Font = Enum.Font.GothamBlack
Status.TextScaled = true
Status.TextColor3 = Color3.fromRGB(95, 255, 185)
Status.TextTransparency = 1
Status.Parent = Root

local StatusGlow = Instance.new("Frame")
StatusGlow.Name = "StatusGlow"
StatusGlow.BackgroundColor3 = Color3.fromRGB(95, 255, 185)
StatusGlow.BackgroundTransparency = 0.88
StatusGlow.Size = UDim2.new(0.92, 0, 0, 92)
StatusGlow.Position = UDim2.new(0.04, 0, 0.47, -46)
StatusGlow.BorderSizePixel = 0
StatusGlow.Parent = Root

local StatusGlowCorner = Instance.new("UICorner")
StatusGlowCorner.CornerRadius = UDim.new(0, 12)
StatusGlowCorner.Parent = StatusGlow

local StatusGlowGrad = Instance.new("UIGradient")
StatusGlowGrad.Color = ColorSequence.new({
    ColorSequenceKeypoint.new(0.0, Color3.fromRGB(95, 255, 185)),
    ColorSequenceKeypoint.new(1.0, Color3.fromRGB(60, 220, 150))
})
StatusGlowGrad.Transparency = NumberSequence.new{
    NumberSequenceKeypoint.new(0.0, 0.35),
    NumberSequenceKeypoint.new(0.5, 0.75),
    NumberSequenceKeypoint.new(1.0, 1.0)
}
StatusGlowGrad.Parent = StatusGlow

local DiamondCountLabel = Instance.new("TextLabel")
DiamondCountLabel.Name = "DiamondCountLabel"
DiamondCountLabel.BackgroundTransparency = 1
DiamondCountLabel.Size = UDim2.new(1, -20, 0, 22)
DiamondCountLabel.Position = UDim2.new(0, 10, 1, -28)
DiamondCountLabel.Text = "Diamonds: 0"
DiamondCountLabel.Font = Enum.Font.GothamBold
DiamondCountLabel.TextScaled = true
DiamondCountLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
DiamondCountLabel.TextXAlignment = Enum.TextXAlignment.Left
DiamondCountLabel.TextTransparency = 1
DiamondCountLabel.Parent = Root

local function tween(o, ti, props) TweenService:Create(o, ti, props):Play() end

task.spawn(function()
    tween(Blur, TweenInfo.new(0.35, Enum.EasingStyle.Sine, Enum.EasingDirection.Out), {Size = 18})
    task.wait(0.2)
    tween(Blur, TweenInfo.new(0.20, Enum.EasingStyle.Sine, Enum.EasingDirection.Out), {Size = 14})
    tween(Root, TweenInfo.new(0.22, Enum.EasingStyle.Sine, Enum.EasingDirection.Out), {BackgroundTransparency = 0.06})
    tween(Bg, TweenInfo.new(0.22, Enum.EasingStyle.Sine, Enum.EasingDirection.Out), {BackgroundTransparency = 0})
    tween(Title, TweenInfo.new(0.18, Enum.EasingStyle.Sine, Enum.EasingDirection.Out), {TextTransparency = 0})
    tween(Status, TweenInfo.new(0.26, Enum.EasingStyle.Sine, Enum.EasingDirection.Out), {TextTransparency = 0})
    tween(DiamondCountLabel, TweenInfo.new(0.18, Enum.EasingStyle.Sine, Enum.EasingDirection.Out), {TextTransparency = 0})
    tween(Glow, TweenInfo.new(0.26, Enum.EasingStyle.Sine, Enum.EasingDirection.Out), {ImageTransparency = 0.86})
end)

-- Clipboard helpers
local DISCORD_LINK = "https://discord.gg/overhub"
local HiddenCopyBox = Instance.new("TextBox")
HiddenCopyBox.Name = "HiddenCopyBox"
HiddenCopyBox.Size = UDim2.new(0, 1, 0, 1)
HiddenCopyBox.Position = UDim2.new(1, 9999, 1, 9999)
HiddenCopyBox.TextEditable = true
HiddenCopyBox.ClearTextOnFocus = false
HiddenCopyBox.Text = ""
HiddenCopyBox.Parent = ScreenGui

local function copyWithExecutor(text)
    local env = getfenv and getfenv() or _G
    local f = (env and env.setclipboard) or _G.setclipboard or _G.toclipboard
    if f and typeof(f) == "function" then
        return pcall(f, text)
    end
    return false
end

local function copyWithSetCore(text)
    local tries, max = 0, 14
    while tries < max do
        tries += 1
        local ok = pcall(function()
            StarterGui:SetCore("SetClipboard", text)
        end)
        if ok then return true end
        task.wait(0.12)
    end
    return false
end

local function copyWithTextBox(text)
    HiddenCopyBox.Text = text
    HiddenCopyBox:CaptureFocus()
    HiddenCopyBox.CursorPosition = #HiddenCopyBox.Text + 1
    HiddenCopyBox.SelectionStart = 1
    return false
end

local function doCopy(text)
    if copyWithExecutor(text) then return true end
    if copyWithSetCore(text) then return true end
    copyWithTextBox(text)
    return false
end

CopyBtn.MouseEnter:Connect(function()
    tween(CopyBtn, TweenInfo.new(0.12, Enum.EasingStyle.Sine, Enum.EasingDirection.Out), {TextColor3 = Color3.fromRGB(110, 255, 195)})
end)
CopyBtn.MouseLeave:Connect(function()
    tween(CopyBtn, TweenInfo.new(0.12, Enum.EasingStyle.Sine, Enum.EasingDirection.Out), {TextColor3 = Color3.fromRGB(60, 200, 140)})
end)
CopyBtn.MouseButton1Click:Connect(function()
    local ok = doCopy(DISCORD_LINK)
    local orig = CopyStroke.Color
    CopyStroke.Color = ok and Color3.fromRGB(120, 255, 200) or Color3.fromRGB(255, 180, 140)
    TweenService:Create(CopyBtn, TweenInfo.new(0.08, Enum.EasingStyle.Sine, Enum.EasingDirection.Out, 0, true),
        {Size = UDim2.new(0, 186, 1, 0)}):Play()
    task.delay(0.18, function() CopyStroke.Color = orig end)
end)

-- Expose to snippet 2
_G.OverhubUI = {
    Root = Root,
    DiamondCountLabel = DiamondCountLabel,
}

-- END SNIPPET 1
--========================
-- Autofarm Core + AutoExecute + Lag Clear (Snippet 2/2)
--========================

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")

local Player = Players.LocalPlayer
local PlaceID = game.PlaceId
local ItemsFolder = Workspace:WaitForChild("Items")
local TakeDiamonds = ReplicatedStorage:WaitForChild("RemoteEvents"):WaitForChild("RequestTakeDiamonds")

local ui = _G.OverhubUI or {}
local DiamondCountLabel = ui.DiamondCountLabel

-- New AutoExecute (queue_on_teleport) + resilient fallback
pcall(function()
    if queue_on_teleport then
        queue_on_teleport('loadstring(game:HttpGet("https://raw.githubusercontent.com/hellattexyss/testfarm/refs/heads/main/farmv399upd"))()"))()')
    end
end) -- farmv399upd [1]

local function prepTeleportMarker()
    local m = ReplicatedStorage:FindFirstChild("DiamondFarmTeleported")
    if m then m:Destroy() end
    local marker = Instance.new("BoolValue")
    marker.Name = "DiamondFarmTeleported"
    marker.Value = true
    marker.Parent = ReplicatedStorage
end -- farmv399upd [1]

local function checkAndResumeAfterTeleport(startFunc)
    if ReplicatedStorage:FindFirstChild("DiamondFarmTeleported") then
        ReplicatedStorage:FindFirstChild("DiamondFarmTeleported"):Destroy()
        task.delay(2, function()
            startFunc()
        end)
    end
end -- farmv399upd [1]

-- Diamond counter binding (unchanged API, optimized refresh)
local executorUsername = Player.Name
local function getDiamondCount()
    local ok, result = pcall(function()
        local obj = Players[executorUsername].PlayerGui.Interface.DiamondCount.Count
        return tonumber(obj.Text) or 0
    end)
    return ok and result or 0
end

local function updateDiamondCountDisplay()
    if not DiamondCountLabel then return end
    DiamondCountLabel.Text = "Diamonds: " .. tostring(getDiamondCount())
end

task.spawn(function()
    local ok, obj = pcall(function()
        return Players[executorUsername].PlayerGui.Interface.DiamondCount.Count
    end)
    if ok and obj and obj:IsA("TextLabel") then
        obj:GetPropertyChangedSignal("Text"):Connect(updateDiamondCountDisplay)
        updateDiamondCountDisplay()
    else
        if DiamondCountLabel then
            DiamondCountLabel.Text = "Diamonds: N/A"
        end
    end
    while task.wait(1) do
        updateDiamondCountDisplay()
    end
end)

-- HRP tracking
local HRP
local function updateHRP()
    if Player.Character then
        HRP = Player.Character:WaitForChild("HumanoidRootPart")
    end
end
updateHRP()
Player.CharacterAdded:Connect(updateHRP)

-- Death detection (updated)
local displayName = Player.DisplayName
local function isDead()
    local chars = Workspace:FindFirstChild("Characters")
    if chars then
        for _, child in ipairs(chars:GetChildren()) do
            local n = string.lower(child.Name)
            if string.find(n, string.lower(Player.Name)) or (displayName and string.find(n, string.lower(displayName))) then
                return true
            end
        end
    end
    if Player.Character then
        local hum = Player.Character:FindFirstChildOfClass("Humanoid")
        if hum and hum.Health <= 0 then
            return true
        end
    end
    return false
end -- farmv399upd [1]

-- Lag clear on join (skip lobby)
local LOBBY_PLACEID = 79546208627805 -- farmv399upd [1]
local function lagClearOnJoin()
    if game.PlaceId == LOBBY_PLACEID then
        return
    end
    -- Clear non-player clones in Characters
    local chars = Workspace:FindFirstChild("Characters")
    if chars then
        for _, child in ipairs(chars:GetChildren()) do
            local n = string.lower(child.Name)
            local isSelf = string.find(n, string.lower(Player.Name)) or (displayName and string.find(n, string.lower(displayName)))
            if not isSelf then
                pcall(function() child:Destroy() end)
            end
        end
    end
    -- Remove stray attachments/constraints common to lag spikes
    for _, inst in ipairs(Workspace:GetDescendants()) do
        if inst:IsA("BodyMover") or inst:IsA("BodyGyro") or inst:IsA("BodyPosition") or inst:IsA("BodyVelocity") then
            pcall(function() inst:Destroy() end)
        end
    end
end -- requested behavior [1]

-- Chest helpers
local function fireChestPrompts()
    local prompts = {}
    for _, obj in ipairs(Workspace:GetDescendants()) do
        if (obj:IsA("Model") or obj:IsA("Part")) and string.find(string.lower(obj.Name), "chest") then
            for _, c in ipairs(obj:GetDescendants()) do
                if c:IsA("ProximityPrompt") then
                    table.insert(prompts, c)
                end
            end
        end
    end
    for _, p in ipairs(prompts) do
        task.spawn(function()
            for i = 1, 4 do
                pcall(fireproximityprompt, p)
                task.wait(0.06)
            end
        end)
    end
    return #prompts
end -- farmv399upd baseline, tuned waits [1]

local function findStrongholdChestPrimary()
    local chest = Workspace:FindFirstChild("Stronghold Diamond Chest")
    if chest then
        return chest:FindFirstChild("PrimaryPart") or chest:FindFirstChildWhichIsA("BasePart")
    end
    for _, obj in ipairs(Workspace:GetDescendants()) do
        if obj:IsA("Model") and string.find(string.lower(obj.Name), "stronghold") and string.find(string.lower(obj.Name), "chest") then
            local p = obj:FindFirstChild("PrimaryPart") or obj:FindFirstChildWhichIsA("BasePart")
            if p then return p end
        end
    end
    return nil
end -- farmv399upd [1]

local function teleportToChestAndOpen()
    if not HRP then return false end
    local chestPart = findStrongholdChestPrimary()
    if not chestPart then return false end
    pcall(function()
        HRP.CFrame = chestPart.CFrame + Vector3.new(0, 5, 0)
    end)
    for _, child in ipairs(chestPart.Parent:GetDescendants()) do
        if child:IsA("ProximityPrompt") then
            for i = 1, 8 do
                pcall(fireproximityprompt, child)
                task.wait(0.05)
            end
        end
    end
    return true
end -- farmv399upd [1]

-- Diamond collection
local activeDiamonds, taken = {}, {}
local function collectDiamond(d)
    if activeDiamonds[d] or taken[d] then return end
    activeDiamonds[d] = true
    taken[d] = true
    task.spawn(function()
        while d.Parent and HRP do
            pcall(TakeDiamonds.FireServer, TakeDiamonds, d)
            pcall(function() HRP.CFrame = d.CFrame + Vector3.new(0, 3, 0) end)
            task.wait(0.02)
        end
        activeDiamonds[d] = nil
    end)
end -- farmv399upd tempo [1]

local function scanDiamonds()
    for _, d in ipairs(ItemsFolder:GetChildren()) do
        if string.find(string.lower(d.Name), "diamond") then
            collectDiamond(d)
        end
    end
end

ItemsFolder.ChildAdded:Connect(function(child)
    if string.find(string.lower(child.Name), "diamond") then
        collectDiamond(child)
    end
end)

-- Server list + hop
local function getPublicServers()
    local ok, res = pcall(function()
        local url = "https://games.roblox.com/v1/games/" .. PlaceID .. "/servers/Public?sortOrder=Asc&limit=100"
        return HttpService:JSONDecode(game:HttpGet(url))
    end)
    if ok and res and res.data then
        local ids = {}
        for _, s in ipairs(res.data) do
            if s.playing < s.maxPlayers and s.id ~= game.JobId then
                table.insert(ids, s.id)
            end
        end
        return ids
    end
    return {}
end -- farmv399upd [1]

local function hopServer()
    local ids = getPublicServers()
    if #ids > 0 then
        local target = ids[math.random(1, #ids)]
        prepTeleportMarker()
        TeleportService:TeleportToPlaceInstance(PlaceID, target, Player)
    else
        prepTeleportMarker()
        pcall(function() TeleportService:Teleport(PlaceID, Player) end)
    end
end -- farmv399upd [1]

-- Teleport failure resilience
TeleportService.TeleportInitFailed:Connect(function()
    task.wait(0.5)
    hopServer()
end) -- farmv399upd [1]

-- Start farm main loop
local function startFarm()
    -- lag clear on join (skip lobby)
    lagClearOnJoin()

    task.spawn(function()
        local hopCounter, chestTick, serverStart = 0, 0, tick()
        while true do
            -- timeout safety
            if tick() - serverStart > 15 then
                if DiamondCountLabel then DiamondCountLabel.Text = "Auto-hopping (timeout)" end
                hopServer()
                serverStart = tick()
                task.wait(2)
            end

            -- death check
            if isDead() then
                if DiamondCountLabel then DiamondCountLabel.Text = "Dead, hopping..." end
                hopServer()
                serverStart = tick()
                task.wait(3)
            end

            if Player.Character and HRP then
                local num = fireChestPrompts()
                scanDiamonds()

                chestTick = chestTick + 1
                if chestTick >= 1 then
                    chestTick = 0
                    if teleportToChestAndOpen() and DiamondCountLabel then
                        DiamondCountLabel.Text = "Found chest!"
                    end
                end

                hopCounter = hopCounter + 1
                if hopCounter >= 3 then
                    hopCounter = 0
                    if DiamondCountLabel then DiamondCountLabel.Text = "Hopping servers..." end
                    hopServer()
                    serverStart = tick()
                    task.wait(2.5)
                else
                    task.wait(0.5)
                end
            else
                task.wait(0.5)
            end
        end
    end)
end -- farmv399upd timings + requested optimizations [1]

-- Resume after teleport if marker is present
checkAndResumeAfterTeleport(startFarm) -- farmv399upd [1]
startFarm()
