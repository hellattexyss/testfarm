-- OverHub Autofarm (compact): smaller UI, legacy logic, auto-queue, queue_on_teleport fallback, death/cleanup, chest assist, hop+retry, per-collection webhook

local G=getgenv and getgenv() or _G
G.Webhook=G.Webhook or (rawget(_G,"Webhook") or "")
G.ReexecURL=G.ReexecURL or (rawget(_G,"ReexecURL") or "")
G.MaxServerTime=tonumber(G.MaxServerTime or rawget(_G,"MaxServerTime")) or 15

local Pl=game:GetService("Players");local Tw=game:GetService("TweenService");local St=game:GetService("StarterGui")
local UI=game:GetService("UserInputService");local Ws=game:GetService("Workspace");local Rs=game:GetService("ReplicatedStorage")
local Tp=game:GetService("TeleportService");local Hs=game:GetService("HttpService")
local lp=Pl.LocalPlayer;local pg=lp:WaitForChild("PlayerGui");local placeId=game.PlaceId

-- UI (smaller)
for _,n in ipairs({"DiamondFarmGUI","AutoFarmDiamondsGUI"}) do local f=pg:FindFirstChild(n) if f then f:Destroy() end end
local blur=Instance.new("BlurEffect",Ws.CurrentCamera) blur.Enabled=true blur.Size=0
local gui=Instance.new("ScreenGui",pg) gui.Name="AutoFarmDiamondsGUI" gui.ResetOnSpawn=false gui.IgnoreGuiInset=true
local root=Instance.new("Frame",gui) root.Name="Root" root.Size=UDim2.new(0,392,0,204) root.Position=UDim2.new(0.5,0,0.48,0) root.AnchorPoint=Vector2.new(0.5,0.5)
root.BackgroundColor3=Color3.fromRGB(18,38,22) root.BackgroundTransparency=1 root.BorderSizePixel=0 root.ClipsDescendants=true
Instance.new("UICorner",root).CornerRadius=UDim.new(0,14)
local stroke=Instance.new("UIStroke",root) stroke.Thickness=1 stroke.Color=Color3.fromRGB(60,200,140) stroke.Transparency=0.1 stroke.ApplyStrokeMode=Enum.ApplyStrokeMode.Border
local glow=Instance.new("ImageLabel",root) glow.BackgroundTransparency=1 glow.AnchorPoint=Vector2.new(0.5,0.5) glow.Position=UDim2.fromScale(0.5,0.5) glow.Size=UDim2.new(1,100,1,100)
glow.Image="rbxasset://textures/whiteSquare.png" glow.ImageColor3=Color3.fromRGB(60,210,150) glow.ImageTransparency=0.86 glow.ScaleType=Enum.ScaleType.Slice glow.SliceCenter=Rect.new(10,10,246,246)
local bg=Instance.new("Frame",root) bg.Size=UDim2.fromScale(1,1) bg.BackgroundTransparency=1 Instance.new("UICorner",bg).CornerRadius=UDim.new(0,14)
local grad=Instance.new("UIGradient",bg) grad.Color=ColorSequence.new{ColorSequenceKeypoint.new(0,Color3.fromRGB(22,56,32)),ColorSequenceKeypoint.new(1,Color3.fromRGB(18,96,58))} grad.Rotation=90
local header=Instance.new("Frame",root) header.BackgroundTransparency=1 header.Size=UDim2.new(1,-20,0,34) header.Position=UDim2.new(0,10,0,10)
local left=Instance.new("Frame",header) left.BackgroundTransparency=1 left.Size=UDim2.new(0.5,-5,1,0)
local right=Instance.new("Frame",header) right.BackgroundTransparency=1 right.Size=UDim2.new(0.5,-5,1,0) right.Position=UDim2.new(0.5,10,0,0)
local title=Instance.new("TextLabel",left) title.BackgroundTransparency=1 title.AnchorPoint=Vector2.new(0,1) title.Position=UDim2.new(0,0,1,0) title.Size=UDim2.new(1,0,1,0)
title.Text="OverHub Autofarm" title.Font=Enum.Font.GothamBold title.TextColor3=Color3.fromRGB(255,255,255) title.TextScaled=true title.TextXAlignment=Enum.TextXAlignment.Left title.TextTransparency=1
local copy=Instance.new("TextButton",right) copy.Name="CopyDiscord" copy.AnchorPoint=Vector2.new(1,1) copy.Position=UDim2.new(1,0,1,0) copy.Size=UDim2.new(0,176,1,2)
copy.BackgroundTransparency=1 copy.Text="Copy Discord Link" copy.Font=Enum.Font.GothamBold copy.TextScaled=true copy.TextColor3=Color3.fromRGB(60,200,140)
Instance.new("UICorner",copy).CornerRadius=UDim.new(0,10) local cst=Instance.new("UIStroke",copy) cst.Thickness=1 cst.Color=Color3.fromRGB(60,200,140) cst.ApplyStrokeMode=Enum.ApplyStrokeMode.Border
local status=Instance.new("TextLabel",root) status.BackgroundTransparency=1 status.Size=UDim2.new(1,-30,0,76) status.Position=UDim2.new(0,15,0.47,-38)
status.Text="AUTOFARM: ON" status.Font=Enum.Font.GothamBlack status.TextScaled=true status.TextColor3=Color3.fromRGB(95,255,185) status.TextTransparency=1
local sgl=Instance.new("Frame",root) sgl.BackgroundColor3=Color3.fromRGB(95,255,185) sgl.BackgroundTransparency=0.88 sgl.Size=UDim2.new(0.92,0,0,80) sgl.Position=UDim2.new(0.04,0,0.47,-40)
Instance.new("UICorner",sgl).CornerRadius=UDim.new(0,12)
local sgg=Instance.new("UIGradient",sgl) sgg.Color=ColorSequence.new{ColorSequenceKeypoint.new(0,Color3.fromRGB(95,255,185)),ColorSequenceKeypoint.new(1,Color3.fromRGB(60,220,150))}
sgg.Transparency=NumberSequence.new{NumberSequenceKeypoint.new(0,0.35),NumberSequenceKeypoint.new(0.5,0.75),NumberSequenceKeypoint.new(1,1)}
local dlab=Instance.new("TextLabel",root) dlab.BackgroundTransparency=1 dlab.Size=UDim2.new(1,-18,0,20) dlab.Position=UDim2.new(0,9,1,-24)
dlab.Text="Diamonds: 0" dlab.Font=Enum.Font.GothamBold dlab.TextScaled=true dlab.TextColor3=Color3.fromRGB(255,255,255) dlab.TextXAlignment=Enum.TextXAlignment.Left dlab.TextTransparency=1

local function tw(o,t,p) Tw:Create(o,t,p):Play() end
task.spawn(function()
    tw(blur,TweenInfo.new(0.35,Enum.EasingStyle.Sine,Enum.EasingDirection.Out),{Size=18})
    task.wait(0.2); tw(blur,TweenInfo.new(0.20,Enum.EasingStyle.Sine,Enum.EasingDirection.Out),{Size=14})
    tw(root,TweenInfo.new(0.22,Enum.EasingStyle.Sine,Enum.EasingDirection.Out),{BackgroundTransparency=0.06})
    tw(bg,TweenInfo.new(0.22,Enum.EasingStyle.Sine,Enum.EasingDirection.Out),{BackgroundTransparency=0})
    tw(title,TweenInfo.new(0.18,Enum.EasingStyle.Sine,Enum.EasingDirection.Out),{TextTransparency=0})
    tw(status,TweenInfo.new(0.26,Enum.EasingStyle.Sine,Enum.EasingDirection.Out),{TextTransparency=0})
    tw(dlab,TweenInfo.new(0.18,Enum.EasingStyle.Sine,Enum.EasingDirection.Out),{TextTransparency=0})
    tw(glow,TweenInfo.new(0.26,Enum.EasingStyle.Sine,Enum.EasingDirection.Out),{ImageTransparency=0.86})
end)

-- Clipboard chain
local HBox=Instance.new("TextBox",gui) HBox.Size=UDim2.new(0,1,0,1) HBox.Position=UDim2.new(1,9999,1,9999) HBox.TextEditable=true HBox.ClearTextOnFocus=false
local function cpExec(t) local e=getfenv and getfenv() or _G local f=(e and e.setclipboard) or _G.setclipboard or _G.toclipboard if f and typeof(f)=="function" then return pcall(f,t) end return false end
local function cpCore(t) for i=1,14 do if pcall(function() St:SetCore("SetClipboard",t) end) then return true end task.wait(0.12) end return false end
local function cpBox(t) HBox.Text=t HBox:CaptureFocus() HBox.CursorPosition=#HBox.Text+1 HBox.SelectionStart=1 return false end
local function doCopy(t) if cpExec(t) then return true end if cpCore(t) then return true end cpBox(t) return false end
copy.MouseEnter:Connect(function() tw(copy,TweenInfo.new(0.12,Enum.EasingStyle.Sine,Enum.EasingDirection.Out),{TextColor3=Color3.fromRGB(110,255,195)}) end)
copy.MouseLeave:Connect(function() tw(copy,TweenInfo.new(0.12,Enum.EasingStyle.Sine,Enum.EasingDirection.Out),{TextColor3=Color3.fromRGB(60,200,140)}) end)
copy.MouseButton1Click:Connect(function() local ok=doCopy("https://discord.gg/overhub") local oc=cst.Color cst.Color= ok and Color3.fromRGB(120,255,200) or Color3.fromRGB(255,180,140)
    Tw:Create(copy,TweenInfo.new(0.08,Enum.EasingStyle.Sine,Enum.EasingDirection.Out,0,true),{Size=UDim2.new(0,170,1,0)}):Play()
    task.delay(0.18,function() cst.Color=oc end)
end)

-- Dragging
do
    local dragging,dragStart,startPos,dragInput=false,nil,nil,nil
    local function upd(i) local d=i.Position-dragStart root.Position=UDim2.new(startPos.X.Scale,startPos.X.Offset+d.X,startPos.Y.Scale,startPos.Y.Offset+d.Y) end
    root.InputBegan:Connect(function(i)
        if i.UserInputType==Enum.UserInputType.MouseButton1 or i.UserInputType==Enum.UserInputType.Touch then
            dragging=true;dragStart=i.Position;startPos=root.Position
            i.Changed:Connect(function() if i.UserInputState==Enum.UserInputState.End then dragging=false end end)
        end
    end)
    root.InputChanged:Connect(function(i) if i.UserInputType==Enum.UserInputType.MouseMovement or i.UserInputType==Enum.UserInputType.Touch then dragInput=i end end)
    UI.InputChanged:Connect(function(i) if i==dragInput and dragging then upd(i) end end)
end

_G.OverhubUI={Root=root,DiamondCountLabel=dlab,Status=status}

-- Core objects
local RemoteEvents=Rs:WaitForChild("RemoteEvents",9e9)
local Take=RemoteEvents:WaitForChild("RequestTakeDiamonds",9e9)
local Items=Ws:WaitForChild("Items",9e9)
local uname=lp.Name local dname=lp.DisplayName
local HRP=nil local function updHRP() if lp.Character then HRP=lp.Character:WaitForChild("HumanoidRootPart") end end updHRP() lp.CharacterAdded:Connect(updHRP)

-- Diamond UI binding
local function getCount() local ok,res=pcall(function() local o=Pl[uname].PlayerGui.Interface.DiamondCount.Count return tonumber(o.Text) or 0 end) return ok and res or 0 end
local function setCount() if not dlab then return 0 end local n=getCount() dlab.Text="Diamonds: "..n return n end
task.spawn(function()
    local ok,o=pcall(function() return Pl[uname].PlayerGui.Interface.DiamondCount.Count end)
    if ok and o and o:IsA("TextLabel") then o:GetPropertyChangedSignal("Text"):Connect(setCount) setCount() else dlab.Text="Diamonds: N/A" end
    while true do setCount() task.wait(1) end
end)

-- Death + cleanup
local function dead()
    local cf=Ws:FindFirstChild("Characters")
    if cf then for _,c in ipairs(cf:GetChildren()) do if c.Name:lower():find(uname:lower()) or (dname and c.Name:lower():find(dname:lower())) then return true end end end
    if lp.Character then local h=lp.Character:FindFirstChildOfClass("Humanoid") if h and h.Health<=0 then return true end end
    return false
end
local function clean()
    local cf=Ws:FindFirstChild("Characters") if not cf then return end
    for _,c in ipairs(cf:GetChildren()) do local me=c.Name:lower():find(uname:lower()) or (dname and c.Name:lower():find(dname:lower()))
        if not me then pcall(function() c:Destroy() end) end
    end
end

-- Chest helpers
local function fireChests()
    local t={}
    for _,o in ipairs(Ws:GetDescendants()) do
        if (o:IsA("Model") or o:IsA("Part")) and o.Name:lower():find("chest") then
            for _,p in ipairs(o:GetDescendants()) do if p:IsA("ProximityPrompt") then t[#t+1]=p end end
        end
    end
    for _,p in ipairs(t) do task.spawn(function() for i=1,3 do pcall(fireproximityprompt,p) task.wait(0.1) end end) end
    return #t
end
local function chestPrimary()
    local d=Ws:FindFirstChild("Stronghold Diamond Chest")
    if d then local P=d:FindFirstChild("PrimaryPart") or d:FindFirstChildWhichIsA("BasePart") if P then return P end end
    for _,o in ipairs(Ws:GetDescendants()) do
        if o:IsA("Model") and o.Name:lower():find("stronghold") and o.Name:lower():find("chest") then
            local P=o:FindFirstChild("PrimaryPart") or o:FindFirstChildWhichIsA("BasePart") if P then return P end
        end
    end
    for _,o in ipairs(Ws:GetDescendants()) do
        if (o:IsA("Model") or o:IsA("Part")) and o.Name:lower():find("stronghold") then
            local P=o:FindFirstChild("PrimaryPart") or o:FindFirstChildWhichIsA("BasePart") if P then return P end
        end
    end
    return nil
end
local function tpChest()
    if not HRP then return false end
    local P=chestPrimary()
    if P then if _G.OverhubUI.Status then _G.OverhubUI.Status.Text="Teleporting to chest..." end
        pcall(function() HRP.CFrame=P.CFrame+Vector3.new(0,5,0) end)
        for _,ch in ipairs(P.Parent:GetDescendants()) do if ch:IsA("ProximityPrompt") then for i=1,8 do pcall(fireproximityprompt,ch) task.wait(0.05) end end end
        return true
    end
    return false
end

-- Server hop
local function hop()
    local ids={}
    local ok,res=pcall(function()
        local url="https://games.roblox.com/v1/games/"..placeId.."/servers/Public?sortOrder=Asc&limit=100"
        return Hs:JSONDecode(game:HttpGet(url))
    end)
    if ok and res and res.data then
        for _,s in ipairs(res.data) do if s.playing<s.maxPlayers and s.id~=game.JobId then ids[#ids+1]=s.id end end
        if #ids>0 then Tp:TeleportToPlaceInstance(placeId,ids[math.random(1,#ids)],lp) return true else Tp:Teleport(placeId,lp) return true end
    else Tp:Teleport(placeId,lp) return true end
end

-- Re-exec: queue_on_teleport + markers
local function autoMark()
    if not Rs:FindFirstChild("DiamondFarmMarker") then local v=Instance.new("StringValue",Rs) v.Name="DiamondFarmMarker" v.Value="DiamondFarmScript" end
    local t=Rs:FindFirstChild("DiamondFarmTeleported") if t then t:Destroy() task.wait(2) startFarm() return end
end
local function markTele() local b=Instance.new("BoolValue",Rs) b.Name="DiamondFarmTeleported" b.Value=true end
local function qot()
    local q=G.queue_on_teleport or queue_on_teleport
    if typeof(q)~="function" and syn and syn.queue_on_teleport then q=syn.queue_on_teleport end
    if typeof(q)=="function" then
        local code
        if type(G.ReexecURL)=="string" and #G.ReexecURL>0 then
            code=string.format('Webhook=%q ReexecURL=%q MaxServerTime=%s\nloadstring(game:HttpGet(%q))()', tostring(G.Webhook or ""), tostring(G.ReexecURL or ""), tostring(G.MaxServerTime or 15), tostring(G.ReexecURL))
        else code='-- no ReexecURL; marker fallback' end
        q(code) return true
    end
    return false
end
local function hopAuto() local used=qot() if not used then markTele() end pcall(hop) end
Tp.TeleportInitFailed:Connect(function() task.wait(1) hopAuto() end) -- retry on failure [web:20]

-- Auto game queue pulses (Add/Chosen)
task.spawn(function()
    local ok,Ev=pcall(function() return Rs:WaitForChild("RemoteEvents",9e9):WaitForChild("TeleportEvent",5) end)
    if ok and Ev then local function Add(n) Ev:FireServer("Add",n) task.wait(0.5) Ev:FireServer("Chosen",nil,1) end
        while true do Add(3) Add(2) Add(1) task.wait(0.3) end
    end
end) -- common lobby queue pulse pattern [web:45]

-- Per-collection webhook
local function sendWH(name,newBal)
    if type(G.Webhook)~="string" or #G.Webhook==0 then return end
    local body=Hs:JSONEncode({content=string.format("💎 Diamond Collected\n👤 %s (@%s)\n💠 Item: %s\n💰 New Balance: %d\n🔗 Server: ||%s||", tostring(dname), tostring(uname), name or "Diamond", tonumber(newBal) or 0, tostring(game.JobId))})
    local function req(tbl)
        local ok=pcall(function()
            if syn and syn.request then return syn.request(tbl)
            elseif request then return request(tbl)
            elseif http and http.request then return http.request(tbl)
            else return game:HttpGet(G.Webhook,{Method="POST",Headers={["Content-Type"]="application/json"},Body=body}) end
        end);return ok
    end
    req({Url=G.Webhook,Method="POST",Headers={["Content-Type"]="application/json"},Body=body})
end

-- Collect diamonds
local active,tag=setmetatable({},{__mode="k"}),setmetatable({},{__mode="k"})
local function collect(d)
    if not d or not d.Parent or active[d] or tag[d] then return end
    active[d]=true tag[d]=true
    task.spawn(function()
        local pre=getCount()
        while d.Parent and HRP do pcall(Take.FireServer,Take,d) pcall(function() HRP.CFrame=d.CFrame+Vector3.new(0,3,0) end) task.wait(0.05) end
        task.wait(0.2) local post=getCount() if post and pre and post>pre then sendWH(d.Name or "Diamond",post) end
        active[d]=nil
    end)
end
local function scan() for _,it in ipairs(Items:GetChildren()) do if it.Name:lower():find("diamond") then collect(it) end end end
Items.ChildAdded:Connect(function(ch) if ch.Name:lower():find("diamond") then collect(ch) end end)

-- Main loop
local function setS(t) if _G.OverhubUI and _G.OverhubUI.Status and t then _G.OverhubUI.Status.Text=t end end
clean()
function startFarm()
    task.spawn(function()
        local hopC,chk,started=0,0,tick()
        while true do
            clean()
            if tick()-started>G.MaxServerTime then setS("Auto-hopping (timeout)") hopAuto() started=tick() task.wait(2) continue end
            if dead() then setS("Dead, hopping...") hopAuto() started=tick() task.wait(5) end
            if lp.Character and HRP then
                fireChests(); scan()
                chk+=1; if chk>=1 then chk=0 if tpChest() then setS("Found chest!") task.wait(1) end end
                hopC+=1; if hopC>=3 then hopC=0 setS("Hopping servers...") hopAuto() started=tick() task.wait(3) else task.wait(0.6) end
            else task.wait(0.6) end
        end
    end)
end
autoMark()
startFarm()
-- Queue-on-teleport loader for Snippet A
-- Usage:
-- Webhook="https://discord.com/api/webhooks/..."
-- ReexecURL="https://your.cdn/snippetA.lua"
-- MaxServerTime=15
-- loadstring(game:HttpGet("https://your.cdn/snippetB.lua"))()

local G=getgenv and getgenv() or _G
local function s(x) return x==nil and "" or tostring(x) end
local q=G.queue_on_teleport or queue_on_teleport
if typeof(q)~="function" and syn and syn.queue_on_teleport then q=syn.queue_on_teleport end
if typeof(q)=="function" and type(G.ReexecURL)=="string" and #G.ReexecURL>0 then
    local code=string.format('Webhook=%q ReexecURL=%q MaxServerTime=%s\nloadstring(game:HttpGet(%q))()', s(G.Webhook or ""), s(G.ReexecURL or ""), s(G.MaxServerTime or 15), s(G.ReexecURL))
    q(code)
end
if type(G.ReexecURL)=="string" and #G.ReexecURL>0 then
    pcall(function() loadstring(game:HttpGet(G.ReexecURL))() end)
else
    warn("Set ReexecURL to your Snippet A URL before running this loader")
end
